<!DOCTYPE aspectran PUBLIC "-//ASPECTRAN//DTD Aspectran Configuration 5.0//EN"
                           "http://aspectran.github.io/dtd/aspectran-5.dtd">

<aspectran>

    <description>
        An Aspectran configuration for running Jetty Server.
    </description>

    <environment>
        <properties>
            <item name="jetty.startup" value="false" valueType="boolean"/>
            <item name="jetty.server.port" value="8099" valueType="int"/>
            <item name="jetty.server.minThreads" value="1" valueType="int"/>
            <item name="jetty.server.maxThreads" value="5" valueType="int"/>
        </properties>
    </environment>

    <bean id="jetty.server" class="com.aspectran.with.jetty.JettyServer" lazyInit="true">
        <constructor>
            <arguments>
                <item name="threadPool">
                    <call bean="jetty.threadPool"/>
                </item>
            </arguments>
        </constructor>
        <properties>
            <item name="autoStart" value="%{jetty.startup}"/>
            <item name="connectors" type="array">
                <value><call bean="jetty.connector"/></value>
            </item>
            <item name="handler">
                <call bean="jetty.handler"/>
            </item>
        </properties>
    </bean>

    <bean id="jetty.threadPool" class="org.eclipse.jetty.util.thread.QueuedThreadPool" scope="prototype">
        <properties>
            <item name="minThreads" value="%{jetty.server.minThreads}"/>
            <item name="maxThreads" value="%{jetty.server.maxThreads}"/>
        </properties>
    </bean>

    <bean id="jetty.connector" class="org.eclipse.jetty.server.ServerConnector" scope="prototype">
        <constructor>
            <arguments>
                <item><call bean="jetty.server"/></item>
            </arguments>
        </constructor>
        <properties>
            <item name="port" value="%{jetty.server.port}"/>
        </properties>
    </bean>

    <bean id="jetty.handler" class="org.eclipse.jetty.server.handler.HandlerCollection" scope="prototype">
        <properties>
            <item name="handlers" type="array">
                <value><call bean="jetty.contexts"/></value>
                <value><call bean="jetty.resourceHandler"/></value>
                <value><call bean="jetty.defaultHandler"/></value>
                <value><call bean="jetty.requestLog"/></value>
            </item>
        </properties>
    </bean>

    <bean id="jetty.contexts" class="org.eclipse.jetty.server.handler.ContextHandlerCollection" scope="prototype">
        <properties>
            <item name="handlers" type="array">
                <value><call bean="jetty.contexts.root"/></value>
            </item>
        </properties>
    </bean>

    <bean id="jetty.contexts.root" class="com.aspectran.with.jetty.JettyWebAppContext" scope="prototype">
        <properties>
            <item name="contextPath" value="/"/>
            <item name="war" value="#{basePath}/webapps/root"/>
            <item name="persistTempDirectory" value="true" valueType="boolean"/>
        </properties>
    </bean>

    <bean id="jetty.resourceHandler" class="org.eclipse.jetty.server.handler.ResourceHandler" scope="prototype"/>

    <bean id="jetty.defaultHandler" class="org.eclipse.jetty.server.handler.DefaultHandler" scope="prototype"/>

    <bean id="jetty.requestLog" class="org.eclipse.jetty.server.handler.RequestLogHandler" scope="prototype">
        <properties>
            <item name="requestLog">#{jetty.ncsaRequestLog}</item>
        </properties>
    </bean>

    <bean id="jetty.ncsaRequestLog" class="org.eclipse.jetty.server.NCSARequestLog" scope="prototype">
        <properties>
            <item name="filename">#{basePath}/logs/jetty-yyyy_mm_dd.request.log</item>
            <item name="filenameDateFormat">yyyy_MM_dd</item>
            <item name="logDateFormat">yyyy-MM-dd HH:mm:ss Z</item>
            <item name="logTimeZone">GMT+9</item>
            <item name="retainDays" valueType="int">90</item>
            <item name="append" valueType="boolean">true</item>
            <item name="logLatency" valueType="boolean">true</item>
        </properties>
    </bean>

</aspectran>